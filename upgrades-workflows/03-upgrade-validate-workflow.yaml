apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: cluster-upgrade-validate-workflow-13
  namespace: argo-workflows
spec:
  templates:
    - name: validate-aws-basics
      inputs:
        parameters:
          - name: VPC_ID
            value: ${aws_vpc_id}
          - name: AWS_REGION
            value: ${aws_region}
          - name: CLUSTER_IAM_ROLE_NAME
            value: ${cluster_iam_role_name}
          - name: CLUSTER_SG_ID
            value: ${cluster_primary_security_group_id}
      container:
        image: public.ecr.aws/i9m4f0j6/eks-validate-image:5
        command: ["/bin/sh","-c"]
        args: ['./validate-aws-basics.sh {{inputs.parameters.CLUSTER_IAM_ROLE_NAME}} {{inputs.parameters.VPC_ID}} {{inputs.parameters.CLUSTER_SG_ID}} {{inputs.parameters.AWS_REGION}}']
      outputs:
        artifacts:
        # generate hello-art artifact from /tmp/hello_world.txt
        # artifacts can be directories as well as files
        - name: aws-basics
          path: /tmp/my_file.txt
    - name: validate-apis
      container:
        image: public.ecr.aws/i9m4f0j6/eks-validate-image:5
        command: ["/bin/sh","-c"]
        args: ['echo "====================== Kubent Deprecated APIs report ======================" > /tmp/kubent-report.txt && /usr/local/bin/kubent | tee -a /tmp/kubent-report.txt']
      outputs:
        artifacts:
        # generate hello-art artifact from /tmp/hello_world.txt
        # artifacts can be directories as well as files
        - name: kubent-report
          path: /tmp/kubent-report.txt
    - name: validate-add-ons-self-managed
      container:
        image: public.ecr.aws/i9m4f0j6/eks-validate-image:5
        command: ["/bin/sh","-c"]
        args: ['echo "====================== Self Managed Add-ons ======================" > /tmp/self-addon-report.txt && kubectl get helmreleases -nflux-system | tee -a /tmp/self-addon-report.txt && echo "====================== Deprecated API in helm charts  ======================" >> /tmp/self-addon-report.txt && pluto detect-helm -o wide | tee -a /tmp/self-addon-report.txt']
      outputs:
        artifacts:
        # generate hello-art artifact from /tmp/hello_world.txt
        # artifacts can be directories as well as files
        - name: self-managed-add-on-report
          path: /tmp/self-addon-report.txt
    - name: validate-eks-managed-add-ons
      container:
        image: public.ecr.aws/i9m4f0j6/eks-validate-image:5
        command: ["/bin/sh","-c"]
        args: ['echo "====================== Managed Add-ons report ======================" > /tmp/managed-addons.txt && eksctl get addons --cluster eks-upgrades-workshop --region us-east-2 | tee -a /tmp/managed-addons.txt'] # Change your region and cluster name
      outputs:
        artifacts:
        # generate hello-art artifact from /tmp/hello_world.txt
        # artifacts can be directories as well as files
        - name: eks-managed-add-on-report
          path: /tmp/managed-addons.txt
    - name: get-eks-k8s-documentation
      inputs:
        parameters:
          - name: k8s_version
            value: "1.25"
          - name: VPC_ID
            value: "vpc-04a2856d6fddf5f4f"
      container:
        image: public.ecr.aws/i9m4f0j6/eks-validate-image:5
        command: ["/bin/sh","-c"]
        args: ['echo "====================== Must look URLs ======================" > /tmp/eks-k8s-docs.txt && echo "K8s Rel notes: https://relnotes.k8s.io/?kinds=api-change&kinds=deprecation&releaseVersions={{inputs.parameters.k8s_version}}.0" >> /tmp/eks-k8s-docs.txt && echo "EKS Notes: https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-{{inputs.parameters.k8s_version}}" >> /tmp/eks-k8s-docs.txt'] # Change your region and cluster name
      outputs:
        artifacts:
        # generate hello-art artifact from /tmp/hello_world.txt
        # artifacts can be directories as well as files
        - name: k8s-eks-notes
          path: /tmp/eks-k8s-docs.txt
    - name: cluster-upgrade-validate
      steps:
        - - name: validate-aws-basics
            template: validate-aws-basics
        - - name: validate-apis
            template: validate-apis
        - - name: validate-add-ons-self-managed
            template: validate-add-ons-self-managed
        - - name: validate-eks-managed-add-ons
            template: validate-eks-managed-add-ons
        - - name: get-eks-k8s-documentation
            template: get-eks-k8s-documentation
  entrypoint: cluster-upgrade-validate
  serviceAccountName: full-permissions-service-account
  arguments:
    parameters:
      - name: k8s_version
        value: "1.25"
      - name: VPC_ID
        value: "vpc-04a2856d6fddf5f4f"
